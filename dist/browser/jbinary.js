!function(a){var b=this;"object"==typeof exports?module.exports=a(b,require("jdataview")):"function"==typeof define&&define.amd?define(["jdataview"],function(c){return a(b,c)}):b.jBinary=a(b,b.jDataView)}(function(a,b){"use strict";function c(a,b){return b&&a instanceof b}function d(a){for(var b=1,c=arguments.length;c>b;++b){var d=arguments[b];for(var e in d)void 0!==d[e]&&(a[e]=d[e])}return a}function e(a){return arguments[0]=l(a),d.apply(null,arguments)}function f(a,b,d){return c(d,Function)?d.call(a,b.contexts[0]):d}var g=Array.prototype.slice,h=function(a,b){a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),a.__proto__=b},i=function(a,b,c){b&&Object.defineProperties(a,b),c&&Object.defineProperties(a.prototype,c)};Array.from||!function(){var a=function(){try{var a={},b=Object.defineProperty,c=b(a,a,a)&&b}catch(d){}return c||function(a,b,c){a[b]=c.value}}(),b=Object.prototype.toString,c=function(a){return"function"==typeof a||"[object Function]"==b.call(a)},d=function(a){var b=Number(a);return isNaN(b)?0:0!=b&&isFinite(b)?(b>0?1:-1)*Math.floor(Math.abs(b)):b},e=Math.pow(2,53)-1,f=function(a){var b=d(a);return Math.min(Math.max(b,0),e)},g=function(b){var d=this;if(null==b)throw new TypeError("`Array.from` requires an array-like object, not `null` or `undefined`");{var e,g,h=Object(b);arguments.length>1}if(arguments.length>1){if(e=arguments[1],!c(e))throw new TypeError("When provided, the second argument to `Array.from` must be a function");arguments.length>2&&(g=arguments[2])}for(var i,j,k=f(h.length),l=c(d)?Object(new d(k)):new Array(k),m=0;k>m;)i=h[m],j=e?"undefined"==typeof g?e(i,m):e.call(g,i,m):i,a(l,m,{value:j,configurable:!0,enumerable:!0}),++m;return l.length=k,l};a(Array,"from",{value:g,configurable:!0,writable:!0})}();var j=a.document;"atob"in a&&"btoa"in a||!function(){function b(a){var b,c,e,f,g,h;for(e=a.length,c=0,b="";e>c;){if(f=255&a.charCodeAt(c++),c==e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(c++),c==e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(c++),b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2|(192&h)>>6),b+=d.charAt(63&h)}return b}function c(a){var b,c,d,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=e[255&a.charCodeAt(g++)];while(h>g&&-1==b);if(-1==b)break;do c=e[255&a.charCodeAt(g++)];while(h>g&&-1==c);if(-1==c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(g++),61==d)return i;d=e[d]}while(h>g&&-1==d);if(-1==d)break;i+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(f=255&a.charCodeAt(g++),61==f)return i;f=e[f]}while(h>g&&-1==f);if(-1==f)break;i+=String.fromCharCode((3&d)<<6|f)}return i}var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];a.btoa||(a.btoa=b),a.atob||(a.atob=c)}();var k=a.Promise||function(){throw new ReferenceError("Promises are not supported in your browser.")},l=Object.create;l||(l=function(a){var b=function(){};return b.prototype=a,new b});var m=function(){var a=function d(a,e){return c(a,d)?a.as(e):(c(a,b)||(a=new b(a,void 0,void 0,e?e["jBinary.littleEndian"]:void 0)),c(this,d)?(this.view=a,this.view.seek(0),this.contexts=[],this.as(e,!0)):new d(a,e))};return i(a,null,{toValue:{writable:!0,value:function(a){return f(this,this,a)}},_named:{writable:!0,value:function(a,b,c){return a.displayName=b+" @ "+(void 0!==c?c:this.view.tell()),a}}}),a}(),n=m.prototype,o=n.typeSet={},p=Object.defineProperty;if(p)try{p({},"x",{})}catch(q){p=void 0}else p=function(a,b,c,d){d&&(a[b]=c.value)};var r="jBinary.Cache",s=0;n._getCached=function(a,b,c){if(a.hasOwnProperty(this.cacheKey))return a[this.cacheKey];var d=b(a);return p(a,this.cacheKey,{value:d},c),d},n.getContext=function(a){switch(typeof a){case"undefined":a=0;case"number":return this.contexts[a];case"string":return this.getContext(function(b){return a in b});case"function":for(var b=0;b<this.contexts.length;b++){var c=this.contexts[b];if(a.call(this,c))return c}}},n.inContext=function(a,b){this.contexts.unshift(a);var c=b.call(this);return this.contexts.shift(),c};var t=function(){var a=function b(a){if(!(this instanceof b))return new b(a);this.override={};for(var c in a)c in this?this.override[c]=a[c]:this[c]=a[c];this.read=this.override.read||this.read,this.write=this.override.write||this.write};return i(a,null,{read:{writable:!0,value:function(){throw new TypeError("read() method was not defined.")}},write:{writable:!0,value:function(){throw new TypeError("write() method was not defined.")}},setParams:{writable:!0,value:function(){var a=g.call(arguments),b=this,c=b.params;if(c)for(var d=0;d<c.length;d++)this[c[d]]=a[d];var e=this.override.setParams;return e&&e.apply(this,a),this}},resolve:{writable:!0,value:function(a){var b=this,c=b.typeParams;if(c)for(var d=0;d<c.length;d++){var e=c[d],f=this[e];f&&(this[e]=a(f))}var g=this.override.resolve;return g&&g.call(this,a),this}},_resolvedInherit:{writable:!0,value:function(a){if(a.length)throw new TypeError("Type is already configured and doesn't accept new arguments.");return this}},inherit:{writable:!0,value:function(a,b){return d(e(this).setParams.apply(e(this),Array.from(a)).resolve(b),{inherit:this._resolvedInherit})}},createProperty:{writable:!0,value:function(a){var b=a.view;return e(this,{binary:a,view:b})}},toValue:{writable:!0,value:function(a,b){return b!==!1&&"string"==typeof a?this.binary.getContext(a)[a]:f(this,this.binary,a)}}}),a}();m.Type=t;var u=function(a){var b=function c(b){return this instanceof c?(this.read=this.baseRead,this.write=this.baseWrite,void a.call(this,b)):new c(b)};return h(b,a),i(b,null,{resolve:{writable:!0,value:function(b){return this.baseType&&(this.baseType=b(this.baseType)),a.prototype.resolve.call(this,b)}},createProperty:{writable:!0,value:function(b){var c=a.prototype.createProperty.call(this,b);return this.getBaseType&&(c.baseType=c.binary.getType(c.getBaseType(c.binary.contexts[0]))),c}},baseRead:{writable:!0,value:function(){return this.binary.read(this.baseType)}},baseWrite:{writable:!0,value:function(a){return this.binary.write(this.baseType,a)}}}),b}(t);m.Template=u,n.as=function(a,b){var c=b?this:e(this);return a=a||o,c.typeSet=a===o||o.isPrototypeOf(a)?a:e(o,a),c.cacheKey=r,c.cacheKey=c._getCached(a,function(){return r+"."+ ++s},!0),c},n.seek=function(a,b){if(a=this.toValue(a),void 0!==b){var c=this.view.tell();this.view.seek(a);var d=b.call(this);return this.view.seek(c),d}return this.view.seek(a)},n.tell=function(){return this.view.tell()},n.skip=function(a,b){return this.seek(this.tell()+this.toValue(a),b)},n.slice=function(a,b,c){return new m(this.view.slice(a,b,c),this.typeSet)},n._getType=function(a,b){var d=this;switch(typeof a){case"string":if(!(a in this.typeSet))throw new ReferenceError("Unknown type: "+a);return this._getType(this.typeSet[a],b);case"number":return this._getType(o.bitfield,[a]);case"object":return c(a,t)?a.inherit(b||[],function(a){return d.getType(a)}):c(a,Array)?this._getCached(a,function(a){return d.getType(a[0],a.slice(1))},!0):this._getCached(a,function(a){return d.getType(o.object,[a])},!1)}},n.getType=function(a,b){var d=this._getType(a,b);return d&&!c(a,t)&&(d.name="object"==typeof a?c(a,Array)?a[0]+"("+a.slice(1).join(", ")+")":"object":String(a)),d},n._action=function(a,b,c){if(void 0!==a){a=this.getType(a);var d=this._named(function(){return c.call(this,a.createProperty(this),this.contexts[0])},"["+a.name+"]",b);return void 0!==b?this.seek(b,d):d.call(this)}},n.read=function(a,b){return this._action(a,b,function(a,b){return a.read(b)})},n.readAll=function(){return this.read("jBinary.all",0)},n.write=function(a,b,c){return this._action(a,c,function(a,c){var d=this.tell();return a.write(b,c),this.tell()-d})},n.writeAll=function(a){return this.write("jBinary.all",a,0)},function(a,b){for(var c=0,d=b.length;d>c;c++){var f=b[c];o[f.toLowerCase()]=e(a,{dataType:f})}}(t({params:["littleEndian"],read:function(){return this.view["get"+this.dataType](void 0,this.littleEndian)},write:function(a){this.view["write"+this.dataType](a,this.littleEndian)}}),["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),d(o,{"byte":o.uint8,"float":o.float32,"double":o.float64}),o.array=u({params:["baseType","length"],read:function(){var a=this.toValue(this.length);if(this.baseType===o.uint8)return this.view.getBytes(a,void 0,!0,!0);var b;if(void 0!==a){b=new Array(a);for(var c=0;a>c;c++)b[c]=this.baseRead()}else{var d=this.view.byteLength;for(b=[];this.binary.tell()<d;)b.push(this.baseRead())}return b},write:function(a){if(this.baseType===o.uint8)return this.view.writeBytes(a);for(var b=0,c=a.length;c>b;b++)this.baseWrite(a[b])}}),o.binary=u({params:["length","typeSet"],read:function(){var a=this.binary.tell(),b=this.binary.skip(this.toValue(this.length)),c=this.view.slice(a,b);return new m(c,this.typeSet)},write:function(a){this.binary.write("blob",a.read("blob",0))}}),o.bitfield=t({params:["bitSize"],read:function(){return this.view.getUnsigned(this.bitSize)},write:function(a){this.view.writeUnsigned(a,this.bitSize)}}),o.blob=t({params:["length"],read:function(){return this.view.getBytes(this.toValue(this.length))},write:function(a){this.view.writeBytes(a,!0)}}),o["const"]=u({params:["baseType","value","strict"],read:function(){var a=this.baseRead();if(this.strict&&a!==this.value){if(c(this.strict,Function))return this.strict(a);throw new TypeError("Unexpected value ("+a+" !== "+this.value+").")}return a},write:function(a){this.baseWrite(this.strict||void 0===a?this.value:a)}}),o["enum"]=u({params:["baseType","matches"],setParams:function(a,b){this.backMatches={};for(var c in b)this.backMatches[b[c]]=c},read:function(){var a=this.baseRead();return a in this.matches?this.matches[a]:a},write:function(a){this.baseWrite(a in this.backMatches?this.backMatches[a]:a)}}),o.extend=t({setParams:function(){this.parts=arguments},resolve:function(a){for(var b=this.parts,c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=a(b[e]);this.parts=d},read:function(){var a=this.parts,b=this.binary.read(a[0]);return this.binary.inContext(b,function(){for(var c=1,e=a.length;e>c;c++)d(b,this.read(a[c]))}),b},write:function(a){var b=this.parts;this.binary.inContext(a,function(){for(var c=0,d=b.length;d>c;c++)this.write(b[c],a)})}}),o["if"]=u({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),o.if_not=o.ifNot=u({setParams:function(a,b,c){this.baseType=["if",a,c,b]}}),o.lazy=u({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var a=function(b){return 0===arguments.length?"value"in a?a.value:a.value=a.binary.read(a.innerType):d(a,{wasChanged:!0,value:b}).value};return a[this.marker]=!0,d(a,{binary:d(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(a){a.wasChanged||!a[this.marker]?this.binary.write(this.innerType,a()):this.baseWrite(a.binary)}}),o.object=t({params:["structure","proto"],resolve:function(a){var b={};for(var d in this.structure)b[d]=c(this.structure[d],Function)?this.structure[d]:a(this.structure[d]);this.structure=b},read:function(){var a=this,b=this.structure,d=this.proto?e(this.proto):{};return this.binary.inContext(d,function(){for(var e in b)this._named(function(){var f=c(b[e],Function)?b[e].call(a,d):this.read(b[e]);void 0!==f&&(d[e]=f)},e).call(this)}),d},write:function(a){var b=this,d=this.structure;this.binary.inContext(a,function(){for(var e in d)this._named(function(){c(d[e],Function)?a[e]=d[e].call(b,a):this.write(d[e],a[e])},e).call(this)})}}),o.skip=t({params:["length"],read:function(){this.view.skip(this.toValue(this.length))},write:function(){this.read()}}),o.string=u({params:["length","encoding"],read:function(){return this.view.getString(this.toValue(this.length),void 0,this.encoding)},write:function(a){this.view.writeString(a,this.encoding)}}),o.string0=t({params:["length","encoding"],read:function(){var a=this.view,b=this.length;if(void 0===b){var c,d=a.tell(),e=0;for(b=a.byteLength-d;b>e&&(c=a.getUint8());)e++;var f=a.getString(e,d,this.encoding);return b>e&&a.skip(1),f}return a.getString(b,void 0,this.encoding).replace(/\0.*$/,"")},write:function(a){var b=this.view,c=void 0===this.length?1:this.length-a.length;b.writeString(a,void 0,this.encoding),c>0&&(b.writeUint8(0),b.skip(c-1))}});m.loadData=function(b){return new k(function(d,e){var f;if(c(b,a.Blob))"FileReader"in a?!function(){var a=new FileReader;a.onload=function(){d(this.result)},a.onerror=function(){e(this.error)},a.readAsArrayBuffer(b)}():d((new FileReaderSync).readAsArrayBuffer(b));else if("string"!=typeof b)e(new TypeError("Unsupported source type."));else if(f=b.match(/^data:(.+?)(;base64)?,(.*)$/)){var g=f[2],h=f[3];d((g?atob:decodeURIComponent)(h))}else"XMLHttpRequest"in a?!function(){var a=new XMLHttpRequest;a.open("GET",b,!0),"responseType"in a?a.responseType="arraybuffer":"overrideMimeType"in a?a.overrideMimeType("text/plain; charset=x-user-defined"):a.setRequestHeader("Accept-Charset","x-user-defined"),"onload"in a||(a.onreadystatechange=function(){4===this.readyState&&this.onload()}),a.onload=function(){return 0!==this.status&&200!==this.status?e(new Error("HTTP Error #"+this.status+": "+this.statusText)):("response"in this||(this.response=new VBArray(this.responseBody).toArray()),void d(this.response))},a.onerror=function(){e(new Error("Network error."))},a.send(null)}():e(new TypeError("Unsupported source type."))})},m.load=function(a,b){return m.loadData(a).then(function(a){return new m(a,b)})},n._toURI="URL"in a&&"createObjectURL"in URL?function(a){var b=this.seek(0,function(){return this.view.getBytes()});return URL.createObjectURL(new Blob([b],{type:a}))}:function(a){var b=this.seek(0,function(){return this.view.getString(void 0,void 0,"binary")});return"data:"+a+";base64,"+btoa(b)},n._mimeType=function(a){return a||this.typeSet["jBinary.mimeType"]||"application/octet-stream"},n.toURI=function(a){return this._toURI(this._mimeType(a))};if(j){var v=m.downloader=j.createElement("a");v.style.display="none"}return n.saveAs=function(a,b){var c=this;return new k(function(d,e){if("string"==typeof a){if("msSaveBlob"in navigator)navigator.msSaveBlob(new Blob([c.read("blob",0)],{type:c._mimeType(b)}),a);else{if(!j)return e(new TypeError("Saving from Web Worker is not supported."));v.parentNode||j.body.appendChild(v),v.href=c.toURI(b),v.download=a,v.click(),v.href=v.download=""}d()}else e(new TypeError("Unsupported storage type."))})},m});
//# sourceMappingURL=jbinary.js.map